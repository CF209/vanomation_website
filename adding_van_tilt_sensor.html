<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Adding a Van Tilt Sensor</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Squadfree - v4.6.0
  * Template URL: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top ">
    <div class="container d-flex align-items-center justify-content-between">

      <div class="logo">
        <h1 class="text-light"><a href="index.html"><span>Vanomation</span></a></h1>
        <!-- Uncomment below if you prefer to use an image logo -->
        <!-- <a href="index.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
      </div>

      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link scrollto active" href="index.html#hero">Home</a></li>
          <li><a class="nav-link scrollto" href="index.html#about">About</a></li>
          <li><a class="nav-link scrollto" href="index.html#pictures">Pictures</a></li>
          <li class="dropdown"><a href="#"><span>Tutorials</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li><a href="setting_up_raspberry_pi.html">Setting up the Raspberry Pi</a></li>
              <li><a href="installing_home_assistant.html">Installing Home Assistant</a></li>
              <li><a href="control_the_lights.html">Controlling the Lights</a></li>
              <li><a href="add_wireless_switches.html">Adding Wireless Switches</a></li>
              <li><a href="monitor_solar_power.html">Monitoring Solar Power</a></li>
              <li><a href="monitor_water_level.html">Monitoring Water Level</a></li>
              <li><a href="monitor_propane_level.html">Monitoring Propane Level</a></li>
              <li><a href="adding_van_tilt_sensor.html">Adding a Van Tilt Sensor</a></li>
              <li><a href="autolocking_drawers.html">Auto-Locking Drawers</a></li>
            </ul>
          </li>
          <li><a class="nav-link scrollto" href="future_projects.html">Future Projects</a></li>
         <!-- <li><a class="nav-link scrollto" href="#contact">Contact</a></li> -->
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->

    </div>
  </header><!-- End Header -->

  <main id="main">

    <!-- ======= Breadcrumbs Section ======= -->
    <section class="breadcrumbs">
      <div class="container">

        <div class="d-flex justify-content-between align-items-center">
          <h2>Adding a Van Tilt Sensor</h2>
          <ol>
            <li><a href="index.html">Home</a></li>
            <li>Adding a Van Tilt Sensor</li>
          </ol>
        </div>

      </div>
    </section><!-- End Breadcrumbs Section -->

    <section class="tutorial_imgs">
      <div class="row">
        <div class="portfolio-details-slider swiper">
          <div class="swiper-wrapper align-items-center">

            <div class="swiper-slide">
              <img src="assets/img/tilt/tilt1.jpeg" class="tut_swiper_img" alt="">
            </div>

            <div class="swiper-slide">
              <img src="assets/img/tilt/tilt2.png" class="tut_swiper_img" alt="">
            </div>

            <div class="swiper-slide">
              <img src="assets/img/tilt/tilt3.jpeg" class="tut_swiper_img" alt="">
            </div>

            <div class="swiper-slide">
              <img src="assets/img/tilt/tilt4.png" class="tut_swiper_img" alt="">
            </div>

          </div>
          <div class="swiper-pagination"></div>
        </div>
      </div>
    </section>

    <section class="inner-page">
      <div class="container">
        <div>&nbsp;The next sensor that I thought would be useful in the van was a level sensor to see how flat
          the van currently is. When parking for the night, it's always more comfortable to sleep if the van is level. I
          would always find myself using rocks or inching forward and backward and ask myself "is it better now?". The easy
          solution would be to just stick a bubble level somewhere, but I thought it would be much more interesting to
          incorporate it into my Home Assistant setup.</div>
        <div><br /></div>
        <div>Items needed to set this up:</div>
        <div class="amazon">
          <ul>
            <li><b><a href="https://www.adafruit.com/product/3886" target="_blank">MPU6050
                Accelerometer</a>:</b>&nbsp;This device essentially measures gravity on 3
                axes and can tell you which way is down. It also has a gyroscope which is not needed for this project
            </li>
            <li><b>Other electronics: </b>Either an ESP32/ESP8266 to send the data to your Raspberry
              Pi, or interface it with the Raspberry Pi directly</li>
          </ul>
        </div>
        <div><br /></div>
        <div>&nbsp;Any 2 or 3-axis accelerometer can be used for this project, but I chose to use the MPU6050 because
          it's widely available and many breakout boards exist for it.</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/tilt/tilt1.jpeg">
        </div>
        <div><br /></div>
        <div>&nbsp;The MPU6050 communicates through I2C, so it needs to be connected to the Raspberry Pi or another
          microcontroller. I wanted to mount it on the bottom of my bed platform which was a little too far from the
          Raspberry Pi, so I decided to use an ESP8266 to communicate with the MPU6050 and send the data back to the
          Raspberry Pi over wifi.</div>
        <div><br /></div>
        <div>&nbsp;If you remember the PCB that I designed for the water level sensor, there were a few extra features on
          that board that I hadn't used. One was this 6-pin header with i2c that I added specifically to accomodate an
          MPU6050 module. In its default state, this header works with the Adafruit MPU6050 module I linked above. By
          connecting the JP1 solder jumper, it also accommodates cheaper MPU6050 modules that can be found on Amazon.</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/tilt/tilt2.png">
        </div>
        <div><br /></div>
        <div>&nbsp; The full KICAD files can be found here:</div>
        <div class="tut_link">
          <a href="https://github.com/CF209/kicad/tree/main/ESP8266_Water_Sensor" target="_blank">ESP8266 PCB KICAD Files</a>
        </div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/tilt/tilt3.jpeg">
        </div>
        <div><br /></div>
        <div>&nbsp;I forgot to take a picture of the assembled board, but you can see J1 in the picture above where the
          module is mounted.</div>
        <div><br /></div>
        <div>&nbsp;Next is the software for the ESP8266. Luckily there's functionality in ESPHome for the MPU6050, so the
          software part is very easy. Details on this can be found here:</div>
        <div class="tut_link">
          <a href="https://esphome.io/components/sensor/mpu6050.html" target="_blank">ESPHome MPU6050</a>
        </div>
        <div><br /></div>
        <div>&nbsp;To create the new ESPHome file, open up the ESPHome dashboard (<a
            href="http://192.168.0.101:6052/">http://192.168.0.101:6052/</a>&nbsp;in my case) and click the plus button in
          the bottom right. Choose "Generic ESP8266" and enter your wifi information. In the config file you'll then want
          to add:</div>
        <div class="terminal">
          i2c:<br>
          &emsp; sda: 2<br>
          &emsp; scl: 14<br>
          <br>
          sensor:<br>
          &emsp; - platform: mpu6050<br>
          &emsp;&emsp;&emsp; address: 0x68<br>
          &emsp;&emsp;&emsp; update_interval: 200ms<br>
          &emsp;&emsp;&emsp; accel_x:<br>
          &emsp;&emsp;&emsp;&emsp;&emsp; name: "MPU6050 Accel X"<br>
          &emsp;&emsp;&emsp; accel_y:<br>
          &emsp;&emsp;&emsp;&emsp;&emsp; name: "MPU6050 Accel Y"
        </div>
        <div><br /></div>
        <div>&nbsp;This sets up the i2c pins (change these pin numbers if your configuration is different), then sets up the MPU6050
          sensor. The default i2c address for the MPU6050 is 0x68. I set an update interval of 200ms. The only two
          readings we then need from it are acceleration on the X and Y axes which can then be used to calculate the left
          to right tilt and the front to back tilt of the van. I then programmed the ESP8266 and mounted it underneath my
          bed.</div>
        <div><br /></div>
        <div>&nbsp;With the ESPHome integration in Home Assistant, the new sensor was automatically detected and added. I
          could now view the X and Y acceleration values from the device, but to make it more readable I wanted to convert
          these values to degrees. With some digging around I found this equation:&nbsp;</div>
        <div class="terminal">tilt in degrees = arcsin(acceleration / gravity) * 180 / pi</div>
        <div><br /></div>
        <div>&nbsp;Adding this equation into Home Assistant, I was now getting tilt readings on two axes in degrees. The
          readings seemed a bit off though, so the sensor most likely needed to be calibrated. To calibrate, I used an app
          on my phone to measure the tilt and set my phone on top of my bed platform. I took measurements with the van
          parked at different inclines and averaged the differences to come up with an offset value. I also noticed that
          the degrees readings were inverted from what I wanted, so I added a -1 multiplyer. The final equation was:</div>
        <div class="terminal">tilt in degrees = ((arcsin(acceleration / gravity) * 180 / pi) - offset) * -1</div>
        <div><br /></div>
        <div>Here is the code I added to the Home Assistant configuration file to add this:</div>
        <div class="terminal">
          &emsp; - platform: template<br>
          &emsp;&emsp;&emsp; sensors:<br>
          &emsp;&emsp;&emsp;&emsp;&emsp; x_angle:<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; friendly_name: "X Angle"<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; unit_of_measurement: "°"<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; value_template: '{{ ((asin((states("sensor.mpu6050_accel_x") | float) / 9.81) * 180 / pi) - 2.8) * -1 }}'<br>
          &emsp;&emsp;&emsp;&emsp;&emsp; y_angle:<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; friendly_name: "Y Angle"<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; unit_of_measurement: "°"<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; value_template: '{{ ((asin((states("sensor.mpu6050_accel_y") | float) / 9.81) * 180 / pi) + 0.3) * -1 }}'
        </div>
        <div>&nbsp;There also seemed to be quite a bit of noise on the sensor, so I added a low pass filter as well. It's not perfect, but it helps a bit:</div>
        <div class="terminal">
          &emsp; - platform: filter<br>
          &emsp;&emsp;&emsp; name: "Filtered X Angle"<br>
          &emsp;&emsp;&emsp; entity_id: sensor.x_angle<br>
          &emsp;&emsp;&emsp; filters:<br>
          &emsp;&emsp;&emsp;&emsp;&emsp; - filter: lowpass<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; time_constant: 5<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; precision: 1<br>
          &emsp; - platform: filter<br>
          &emsp;&emsp;&emsp; name: "Filtered Y Angle"<br>
          &emsp;&emsp;&emsp; entity_id: sensor.y_angle<br>
          &emsp;&emsp;&emsp; filters:<br>
          &emsp;&emsp;&emsp;&emsp;&emsp; - filter: lowpass<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; time_constant: 5<br>
          &emsp;&emsp;&emsp;&emsp;&emsp;&emsp;&emsp; precision: 1
        </div>
        <div>&nbsp;The end result is a Home Assistant sensor showing the tilt of the van which makes finding a level parking spot quite a bit easier.</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/tilt/tilt4.png">
        </div>
        <div><br /></div>
        <div class="next_link">
          <a href="autolocking_drawers.html">Next: Auto-Locking Drawers</a>
        </div>
        <div><br /></div>
      </div>
    </section>

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">
    <div class="footer-top">
      <div class="container">
        <div class="row">
          <p style="text-align: center">
            See more at <a href="https://github.com/CF209">https://github.com/CF209</a>
          </p>

        </div>
      </div>
    </div>

    <div class="container">
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/ -->
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/purecounter/purecounter.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>