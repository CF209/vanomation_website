<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Monitoring Propane Level</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Squadfree - v4.6.0
  * Template URL: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top ">
    <div class="container d-flex align-items-center justify-content-between">

      <div class="logo">
        <h1 class="text-light"><a href="index.html"><span>Vanomation</span></a></h1>
        <!-- Uncomment below if you prefer to use an image logo -->
        <!-- <a href="index.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
      </div>

      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link scrollto active" href="index.html#hero">Home</a></li>
          <li><a class="nav-link scrollto" href="index.html#about">About</a></li>
          <li><a class="nav-link scrollto" href="index.html#pictures">Pictures</a></li>
          <li class="dropdown"><a href="#"><span>Tutorials</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li><a href="setting_up_raspberry_pi.html">Setting up the Raspberry Pi</a></li>
              <li><a href="installing_home_assistant.html">Installing Home Assistant</a></li>
              <li><a href="control_the_lights.html">Controlling the Lights</a></li>
              <li><a href="add_wireless_switches.html">Adding Wireless Switches</a></li>
              <li><a href="monitor_solar_power.html">Monitoring Solar Power</a></li>
              <li><a href="monitor_water_level.html">Monitoring Water Level</a></li>
              <li><a href="monitor_propane_level.html">Monitoring Propane Level</a></li>
              <li><a href="adding_van_tilt_sensor.html">Adding a Van Tilt Sensor</a></li>
              <li><a href="autolocking_drawers.html">Auto-Locking Drawers</a></li>
            </ul>
          </li>
          <li><a class="nav-link scrollto" href="future_projects.html">Future Projects</a></li>
         <!-- <li><a class="nav-link scrollto" href="#contact">Contact</a></li> -->
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->

    </div>
  </header><!-- End Header -->

  <main id="main">

    <!-- ======= Breadcrumbs Section ======= -->
    <section class="breadcrumbs">
      <div class="container">

        <div class="d-flex justify-content-between align-items-center">
          <h2>Monitoring Propane Level</h2>
          <ol>
            <li><a href="index.html">Home</a></li>
            <li>Monitoring Propane Level</li>
          </ol>
        </div>

      </div>
    </section><!-- End Breadcrumbs Section -->

    <section class="tutorial_imgs">
        <div class="row">
          <div class="portfolio-details-slider swiper">
            <div class="swiper-wrapper align-items-center">
  
              <div class="swiper-slide">
                <img src="assets/img/propane/propane6.jpg" class="tut_swiper_img" alt="">
              </div>

              <div class="swiper-slide">
                <img src="assets/img/propane/propane7.jpg" class="tut_swiper_img" alt="">
              </div>

              <div class="swiper-slide">
                <img src="assets/img/propane/propane1.webp" class="tut_swiper_img" alt="">
              </div>

              <div class="swiper-slide">
                <img src="assets/img/propane/propane4.png" class="tut_swiper_img" alt="">
              </div>

              <div class="swiper-slide">
                <img src="assets/img/propane/propane5.png" class="tut_swiper_img" alt="">
              </div>
  
            </div>
            <div class="swiper-pagination"></div>
          </div>
        </div>
      </section>

    <section class="inner-page">
      <div class="container">
        <div>&nbsp;Next up was a monitoring system for the level of my propane tank. I have a standard 20lb propane
          tank in my van. It's stored in a sealed box with a vent to the outside, so the traditional method of lifting the
          tank to see how heavy it is and guess how much is left is out of the question. To avoid running out of propane at an inconvenient time, I needed a way to monitor its current level wirelessly.</div>
        <div><br /></div>
        <div>Items needed to set this up:</div>
        <div class="amazon">
          <ul>
            <li><b><a href="https://www.homedepot.com/p/Worthington-20-lbs-Empty-Propane-Tank-309791/202034840"
                  target="_blank">Propane Tank</a>:</b>&nbsp;Any standard 20lb propane tank
                should work. Other size tanks could work as well, but would need some modifications to my script</li>
            <li><b><a href="https://www.amazon.com/gp/product/B01C5RQJHS" target="_blank">Bluetooth
                  Propane Sensor</a>:</b>&nbsp;This is the only wireless propane sensor I've
                been able to find</li>
          </ul>
        </div>
        <div>&nbsp;The propane sensor has its own app which works pretty well on its own. I would always forget to check it
          though.&nbsp;I wanted to integrate it into my Home Assistant setup so I could look at one location for all the
          systems in the van.</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/propane/propane1.webp">
        </div>
        <div><br /></div>
        <div>&nbsp;I reached out to Mopeka to see if they had an API for the sensors, but never received a
        response. Looks like my only option would be to reverse engineer the app.</div>
        <div><br /></div>
        <div>&nbsp;I knew that the sensor communicated using bluetooth, so the first step was to see if I could connect to
          the device with the Raspberry Pi and read any sort of data from it. With some more research, I figured out that
          the device acts as a BLE beacon and sends out its advertisement data every 10 seconds (this interval can be
          changed by holding the SYNC button for 5 seconds). I was able to read this using hcitool and hcidump. I ran these
          three commands in separate terminal sessions:</div>
        <div>
        <div class="terminal">
          sudo hcidump<br><br>
          sudo hcidump --raw<br><br>
          sudo hcitool lescan
        </div>
        <div>&nbsp;"sudo hcitool lescan" scans for bluetooth low energy devices while "hcidump" and "hcidump --raw" dump
          information from scanned devices. Here are the outputs that I got from the propane sensor:</div>
        <div class="terminal">
          stuff**************************************************
        </div>
        <div>&nbsp;The advertisement data included 25 extra bytes of data. I knew the propane level must be encoded in
          this data somewhere.&nbsp;</div>
        <div><br /></div>
        <div>&nbsp;My first attempt at decoding the data was to concurrently capture that data from hcidump and from the
          tank check app and see if I could find any correlation between the two. After many attempts though, I couldn't
          find any sort of obvious correlation. Because of this I concluded that the app must be performing some post
          processing on the data.</div>
        <div><br /></div>
        <div>&nbsp;My only other path was to reverse engineer the app. With some research I learned of a tool called
          Apktool which allows you to unpack a .apk file (an android app file) and view the resources used to build it. It
          also allows you to make changes and rebuild it into a new .apk.</div>
        <div><br /></div>
        <div>&nbsp;I used apktool to unpack V2.5.1 (the latest version when I started working on this) of that tank check
          app that I downloaded here:</div>
        <div class="tut_link">
          <a href="https://apkpure.com/tank-check/com.mopeka.tankcheck" target="_blank">Tank Check App</a>
        </div>
        <div><br /></div>
        <div>&nbsp;Browsing through the files, I found that most of the code was written in javascript and contained in a
          file located here: "assets/www/js/dist.bundle.js". Unfortunately, the code from apktool was not formatted very
          well and almost impossible to read looking like this:</div>
        <div class="tut_img">
          <img src="assets/img/propane/propane2.png">
        </div>
        <div><br /></div>
        <div>I was able to make it more readable using&nbsp;<a href="https://beautifier.io/"
            target="_blank">https://beautifier.io/</a>:</div>
        <div class="tut_img">
          <img src="assets/img/propane/propane3.png">
        </div>
        <div><br /></div>
        <div>&nbsp;Reading through the code, it appeared that apktool preserved the variable and function names that were
          parts of classes, but not any other variable names. Luckily this was enough to help me follow the code. The
          first thing I looked for was the piece of code that printed the percentage reading to the app. I knew if I could
          find this piece of code, I could trace it back to see where the data came from. After finding it, I was also
          able to edit this code and recompile the apk to print other info to help me decode what was going on.</div>
        <div><br /></div>
        <div>&nbsp;I won't go into too many details on reverse engineering the app from here, but I basically followed the
          data through the app from when it's first read in the bluetooth advertisement data to it being converted to a
          percentage. I converted the javascript to python for my own script. I was also able to decode the battery
          percentage, temperature, and quality of the reading from the data.&nbsp;</div>
        <div><br /></div>
        <div>&nbsp;For reading the bluetooth data in the script, I found another python script online that would read BLE
          data and converted it for my needs, filtering by the bluetooth address of my propane sensor. The final script
          which sends this data via MQTT to Home Assistant can be found here. For the script to have access to bluetooth,
          it must be run with "sudo -E"</div>
        <div class="tut_link">
          <a href="https://github.com/CF209/vanomation/blob/main/python/propane/propane_mqtt.py" target="_blank">Propane Level Python Script</a>
        </div>
        <div><br /></div>
        <div>&nbsp;I then created a systemd service for the script:</div>
        <div class="terminal">
          sudo nano /lib/systemd/system/propane_mqqt.service
        </div>
        <div class="terminal">
            [Unit]<br>
            Description=Propane MQTT<br>
            After=multi-user.target<br>
            <br>
            [Service]<br>
            Type=idle<br>
            ExecStart=/usr/bin/sudo -E /usr/bin/python3 /home/pi/python/propane/propane_mqtt.py<br>
            WorkingDirectory=/home/pi<br>
            User=pi<br>
            <br>
            [Install]<br>
            WantedBy=multi-user.target
        </div>
        <div class="terminal">
          sudo systemctl daemon-reload<br>
          sudo systemctl enable propane_mqqt.service
        </div>
        <div>And added the sensors to Home Assistant:</div>
        <div class="terminal">
            sensor:<br>
            - platform: mqtt<br>
              state_topic: "van/propane"<br>
              name: 'Propane Level'<br>
              unit_of_measurement: '%'<br>
              value_template: '{{ value_json.propane_pct }}'<br>
            - platform: mqtt<br>
              state_topic: "van/propane"<br>
              name: 'Propane Sensor Quality'<br>
              value_template: '{{ value_json.propane_qual }}'<br>
            - platform: mqtt<br>
              state_topic: "van/propane"<br>
              name: 'Propane Sensor Battery'<br>
              unit_of_measurement: '%'<br>
              icon: mdi:battery-50<br>
              value_template: '{{ value_json.propane_bat }}'<br>
            - platform: mqtt<br>
              state_topic: "van/propane"<br>
              name: 'Propane Sensor Temperature'<br>
              unit_of_measurement: '°C'<br>
              value_template: '{{ value_json.propane_temp }}'
        </div>
        <div><br /></div>
        <div>The propane sensor can now be added to your Home Assistant dashboard:</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/propane/propane4.png">
        </div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/propane/propane5.png">
        </div>
        <div><br /></div>
        <div class="next_link">
          <a href="adding_van_tilt_sensor.html">Next: Adding a Van Tilt Sensor</a>
        </div>
        <div><br /></div>
      </div>
    </section>

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">
    <div class="footer-top">
      <div class="container">
        <div class="row">

        </div>
      </div>
    </div>

    <div class="container">
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/ -->
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/purecounter/purecounter.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>