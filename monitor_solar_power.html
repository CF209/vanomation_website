<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Monitoring Solar Power</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Squadfree - v4.6.0
  * Template URL: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top ">
    <div class="container d-flex align-items-center justify-content-between">

      <div class="logo">
        <h1 class="text-light"><a href="index.html"><span>Vanomation</span></a></h1>
        <!-- Uncomment below if you prefer to use an image logo -->
        <!-- <a href="index.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
      </div>

      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link scrollto active" href="index.html#hero">Home</a></li>
          <li><a class="nav-link scrollto" href="index.html#about">About</a></li>
          <li><a class="nav-link scrollto" href="index.html#pictures">Pictures</a></li>
          <li class="dropdown"><a href="#"><span>Tutorials</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li><a href="setting_up_raspberry_pi.html">Setting up the Raspberry Pi</a></li>
              <li><a href="installing_home_assistant.html">Installing Home Assistant</a></li>
              <li><a href="control_the_lights.html">Controlling the Lights</a></li>
              <li><a href="add_wireless_switches.html">Adding Wireless Switches</a></li>
              <li><a href="monitor_solar_power.html">Monitoring Solar Power</a></li>
              <li><a href="monitor_water_level.html">Monitoring Water Level</a></li>
              <li><a href="monitor_propane_level.html">Monitoring Propane Level</a></li>
              <li><a href="adding_van_tilt_sensor.html">Adding a Van Tilt Sensor</a></li>
              <li><a href="autolocking_drawers.html">Auto-Locking Drawers</a></li>
            </ul>
          </li>
          <li><a class="nav-link scrollto" href="future_projects.html">Future Projects</a></li>
         <!-- <li><a class="nav-link scrollto" href="#contact">Contact</a></li> -->
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->

    </div>
  </header><!-- End Header -->

  <main id="main">

    <!-- ======= Breadcrumbs Section ======= -->
    <section class="breadcrumbs">
      <div class="container">

        <div class="d-flex justify-content-between align-items-center">
          <h2>Monitoring Solar Power</h2>
          <ol>
            <li><a href="index.html">Home</a></li>
            <li>Monitoring Solar Power</li>
          </ol>
        </div>

      </div>
    </section><!-- End Breadcrumbs Section -->

    <section class="inner-page">
      <div class="container">
        &nbsp;With the lights set up and working, next I wanted to add some monitoring of different systems in the van. The first one I thought I'd tackle was monitoring the solar power by interfacing with my charge controller.<div><br /></div><div>Items needed to set this up:</div><div style="background-color: #eeeeee; border: 2px solid rgb(221, 221, 221); margin: 10px; padding: 2px 6px 4px;"><ul><li><b style="color: #555555;"><a href="https://www.amazon.com/gp/product/B07DNVW37B/ref=as_li_qf_asin_il_tl?ie=UTF8&amp;tag=vanomation-20&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B07DNVW37B&amp;linkId=c44c0c756eaa97f54617c61b74d41d4f" target="_blank">Renogy Rover Charge Controller</a>:</b><span style="color: #555555;">&nbsp;I have the 30A version shown here, but this setup should work with any of charge controllers in this series</span></li><li style="color: #555555;"><b><a href="https://www.amazon.com/gp/product/B00IDSM6BW/ref=as_li_qf_asin_il_tl?ie=UTF8&amp;tag=vanomation-20&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B00IDSM6BW&amp;linkId=87f73b7dbc3036253e5a8779797ff92d" target="_blank">USB Serial Dongle</a></b></li><li style="color: #555555;"><b><a href="https://www.amazon.com/gp/product/B0054RRCHI/ref=as_li_qf_asin_il_tl?ie=UTF8&amp;tag=vanomation-20&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B0054RRCHI&amp;linkId=07bd7751d8997d4b3f435d982202e1ed" target="_blank">DB9 to RJ12 adapter</a></b></li><li style="color: #555555;"><b><a href="https://www.amazon.com/gp/product/B08BHVF6XS/ref=as_li_qf_asin_il_tl?ie=UTF8&amp;tag=vanomation-20&amp;creative=9325&amp;linkCode=as2&amp;creativeASIN=B08BHVF6XS&amp;linkId=ca312d690359da76885a0c909c9d5cdb" target="_blank">RJ12 Cable</a></b></li></ul><div style="color: #555555;"></div></div>&nbsp;In order for the Raspberry Pi to communicate with the Renogy charge controller, we need a USB to RJ12 serial cable. Renogy used to include this cable with their charge controllers, but since introducing their bluetooth module, they stopped making it. So instead we'll have to make our own!<div><br /><div>&nbsp;The three components of the cable are the USB serial dongle which allows the raspberry pi to communicate in the correct protocol for the charge controller, then the DB9 to RJ12 adapter and the RJ12 cable which allows you to connect to the Renogy charge controller with the correct pin mapping.</div></div><div><br /></div><div>&nbsp;The pin mapping of the RJ12 connector for the Renogy charge controller is: TX/RX/GND/GND/+12V/+12V. On the USB serial dongle, pin 2 is RXD, pin 3 is TXD, and pin 5 is GND. We need to connect the RJ12 TX to the serial dongle RXD and the RJ12 RX to the serial dongle TXD. We then need to also connect GND. This is done using the DB9 to RJ12 adapter as shown below.</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEiANrFuyTW8n4GAPC7WZft2DLuXtRVngtv4X3QoLr2UHNnu3ll7kT53h32o2ZjJQ4UqvAunTI7sK2Cin-zoN832LpxS-TQgv7H3PBQf4CjPfp9YRjom-zG2E88kq9ZAMzcv4_wgvqu93Mb7IY6iGJWgBIL7vr6iAHdGR5lZCTdWAKOMLzmGo8OsL-MT=s610" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="406" data-original-width="610" height="213" src="https://blogger.googleusercontent.com/img/a/AVvXsEiANrFuyTW8n4GAPC7WZft2DLuXtRVngtv4X3QoLr2UHNnu3ll7kT53h32o2ZjJQ4UqvAunTI7sK2Cin-zoN832LpxS-TQgv7H3PBQf4CjPfp9YRjom-zG2E88kq9ZAMzcv4_wgvqu93Mb7IY6iGJWgBIL7vr6iAHdGR5lZCTdWAKOMLzmGo8OsL-MT=s320" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEjNC3WMrrl_Ru6oSGIMA_VWzJmfHiDDPbhaoKJli01ei3YClIv8S4wkvidLskGDH2rWRw1bbPACEJDmeOMXTNHmmxOYN3isaW42Y5kTo8cjpe1L7I4tD0l3fivRX3QXUWII27XvraJIE9-HI-kd8kFUuuhvCBx1jwExOI11wBzXjpXwkZv__xOSvySk=s2651" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="1543" data-original-width="2651" height="186" src="https://blogger.googleusercontent.com/img/a/AVvXsEjNC3WMrrl_Ru6oSGIMA_VWzJmfHiDDPbhaoKJli01ei3YClIv8S4wkvidLskGDH2rWRw1bbPACEJDmeOMXTNHmmxOYN3isaW42Y5kTo8cjpe1L7I4tD0l3fivRX3QXUWII27XvraJIE9-HI-kd8kFUuuhvCBx1jwExOI11wBzXjpXwkZv__xOSvySk=s320" width="320" /></a></div><div class="separator" style="clear: both; text-align: center;"><br /></div>&nbsp;Once the cable is made, I recommend connecting it to the Renogy charge controller, then using a multimeter to test the pin voltages before connecting it to the serial dongle. TX to GND and TX to RX should both be about 5V. Make sure you didn't accidentally connect the 12V pins or you could fry the serial dongle and possibly even the raspberry pi.<div><br /></div><div>&nbsp;With the cable now connected between the raspberry pi and the charge controller, we now need some software to read registers from the charge controller. First find the name of the USB serial dongle on your raspberry pi with:</div><div><div style="background-color: #eeeeee; border: 2px solid rgb(221, 221, 221); color: #555555; margin: 10px; padding: 2px 6px 4px;"><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="color: #39c026; font-variant-ligatures: no-common-ligatures;"><b>pi@raspberrypi</b></span><span class="s2" style="font-variant-ligatures: no-common-ligatures;">:</span><span class="s3" style="color: #5620f4; font-variant-ligatures: no-common-ligatures;"><b>~ $</b></span><span class="s2" style="font-variant-ligatures: no-common-ligatures;"> ls /dev/*USB*</span></p><p class="p2" style="color: #878a04; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s4" style="background-color: black; font-variant-ligatures: no-common-ligatures;"><b>/dev/ttyUSB0</b></span></p></div>&nbsp;Now we can start writing a python program. Luckily, someone has already written a library called solarshed that handles reading data from the charge controller. <a href="https://github.com/corbinbs/solarshed" target="_blank">More info on this library here</a>.You can install it with:</div><div><div style="background-color: #eeeeee; border: 2px solid rgb(221, 221, 221); margin: 10px; padding: 2px 6px 4px;"><span style="color: #555555;">pip install solarshed</span></div><div>&nbsp; I have a basic program posted here that reads the current solar power from the charge controller every second and publishes the data to the MQTT server running on the Raspberry Pi:</div></div><div style="text-align: left;"><a href="https://github.com/CF209/vanomation/blob/main/python/solar/solar_mqtt.py" target="_blank">https://github.com/CF209/vanomation/blob/main/python/solar/solar_mqtt.py</a></div><div style="text-align: left;"><br /></div><div>&nbsp;If your serial dongle is at a different address, you can change it on this line:</div><div><div style="background-color: #eeeeee; border: 2px solid rgb(221, 221, 221); margin: 10px; padding: 2px 6px 4px;"><span style="color: #555555;">controller = RenogyRover('/dev/ttyUSB0', 1)</span></div></div><div>&nbsp;You can also edit the script to add monitoring of more than just power or other features.</div><div><br /></div><div>&nbsp;In order to have this script always running, we will turn it into a systemd service. Create a new file with:</div><div><div style="background-color: #eeeeee; border: 2px solid rgb(221, 221, 221); margin: 10px; padding: 2px 6px 4px;"><span style="color: #555555;">sudo nano /lib/systemd/system/solar_mqqt.service</span></div></div><div>And add the following to the file changing&nbsp;ExecStart path to the path of your python script:</div><div><div style="background-color: #eeeeee; border: 2px solid rgb(221, 221, 221); color: #555555; margin: 10px; padding: 2px 6px 4px;"><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">[Unit]</span></p><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">Description=Solar MQTT</span></p><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">After=multi-user.target</span></p><p class="p2" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px; min-height: 13px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;"></span><br /></p><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">[Service]</span></p><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">Type=idle</span></p><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">ExecStart=/usr/bin/python3 /home/pi/python/solar/solar_mqtt.py</span></p><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">WorkingDirectory=/home/pi</span></p><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">User=pi</span></p><p class="p2" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px; min-height: 13px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;"></span><br /></p><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">[Install]</span></p><p class="p1" style="color: black; font-family: Menlo; font-size: 11px; font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span class="s1" style="font-variant-ligatures: no-common-ligatures;">WantedBy=multi-user.target</span></p></div></div><div>&nbsp;Save the file, then you can enable the service with:</div><div><div style="background-color: #eeeeee; border: 2px solid rgb(221, 221, 221); margin: 10px; padding: 2px 6px 4px;"><span style="color: #555555;">sudo systemctl daemon-reload<br />sudo systemctl enable solar_mqqt.service</span></div></div><div>To check that the service is running:</div><div><div style="background-color: #eeeeee; border: 2px solid rgb(221, 221, 221); margin: 10px; padding: 2px 6px 4px;"><span style="color: #555555;">sudo systemctl status solar_mqtt.service</span></div></div><div>&nbsp;The final step is to add this new sensor to Home Assistant. In Home Assistant, go to Configuration -&gt; Integrations and add the MQTT integration if you don't have it already. Now go to your configuration.yaml file in your homeassistant directory and add the following sensor:</div><div><div><div style="background-color: #eeeeee; border: 2px solid rgb(221, 221, 221); margin: 10px; padding: 2px 6px 4px;"><p class="p1" style="font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span style="font-family: Menlo;"><span style="font-size: 11px; font-variant-ligatures: no-common-ligatures;">sensor:</span></span></p><p class="p1" style="font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span style="font-family: Menlo;"><span style="font-size: 11px; font-variant-ligatures: no-common-ligatures;">&nbsp; - platform: mqtt</span></span></p><p class="p1" style="font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span style="font-family: Menlo;"><span style="font-size: 11px; font-variant-ligatures: no-common-ligatures;">&nbsp; &nbsp; state_topic: "van/solar/power"</span></span></p><p class="p1" style="font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span style="font-family: Menlo;"><span style="font-size: 11px; font-variant-ligatures: no-common-ligatures;">&nbsp; &nbsp; name: 'Solar Power'</span></span></p><p class="p1" style="font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span style="font-family: Menlo;"><span style="font-size: 11px; font-variant-ligatures: no-common-ligatures;">&nbsp; &nbsp; unit_of_measurement: 'W'</span></span></p><p class="p1" style="font-stretch: normal; font-variant-east-asian: normal; font-variant-numeric: normal; line-height: normal; margin: 0px;"><span style="font-family: Menlo;"><span style="font-size: 11px; font-variant-ligatures: no-common-ligatures;">&nbsp; &nbsp; value_template: '{{ value_json.power }}'</span></span></p></div></div></div><div>&nbsp;Restart Home Assistant and you should now be able to add the sensor to your dashboard!</div><div><br /></div><div class="separator" style="clear: both; text-align: center;"><a href="https://blogger.googleusercontent.com/img/a/AVvXsEgvTWmWPBeVlJJ2NLUIfC2SN79QFDM3OjsjAFDkZTffl1gs1NCS2hy6GBrhPQdxTKdG6_F7O258WdivhERxL6fWzUusePLy_iGqAjK_WlazfMrslmi-Nz4Ms7W949bV0PqtfR0YJc4QPMYXi_-ksl7m0-EfppY3xvPOpfK3Pd1KZbKfjYTyuKrWnt46=s781" style="margin-left: 1em; margin-right: 1em;"><img border="0" data-original-height="375" data-original-width="781" height="154" src="https://blogger.googleusercontent.com/img/a/AVvXsEgvTWmWPBeVlJJ2NLUIfC2SN79QFDM3OjsjAFDkZTffl1gs1NCS2hy6GBrhPQdxTKdG6_F7O258WdivhERxL6fWzUusePLy_iGqAjK_WlazfMrslmi-Nz4Ms7W949bV0PqtfR0YJc4QPMYXi_-ksl7m0-EfppY3xvPOpfK3Pd1KZbKfjYTyuKrWnt46=s320" width="320" /></a></div><div><br /></div><div style="text-align: center;"><a href="monitor_water_level.html"><b><span style="font-size: medium;">Next:&nbsp;</span></b><span style="text-align: left;"><span style="color: #0000ee; font-size: medium;"><b><u>Monitoring Water Level</u></b></span></span></a></div><div><br /></div>
      </div>
    </section>

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">
    <div class="footer-top">
      <div class="container">
        <div class="row">

        </div>
      </div>
    </div>

    <div class="container">
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/ -->
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/purecounter/purecounter.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>