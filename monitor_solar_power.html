<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Monitoring Solar Power</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Squadfree - v4.6.0
  * Template URL: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top ">
    <div class="container d-flex align-items-center justify-content-between">

      <div class="logo">
        <h1 class="text-light"><a href="index.html"><span>Vanomation</span></a></h1>
        <!-- Uncomment below if you prefer to use an image logo -->
        <!-- <a href="index.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
      </div>

      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link scrollto active" href="index.html#hero">Home</a></li>
          <li><a class="nav-link scrollto" href="index.html#about">About</a></li>
          <li><a class="nav-link scrollto" href="index.html#pictures">Pictures</a></li>
          <li class="dropdown"><a href="#"><span>Tutorials</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li><a href="setting_up_raspberry_pi.html">Setting up the Raspberry Pi</a></li>
              <li><a href="installing_home_assistant.html">Installing Home Assistant</a></li>
              <li><a href="control_the_lights.html">Controlling the Lights</a></li>
              <li><a href="add_wireless_switches.html">Adding Wireless Switches</a></li>
              <li><a href="monitor_solar_power.html">Monitoring Solar Power</a></li>
              <li><a href="monitor_water_level.html">Monitoring Water Level</a></li>
              <li><a href="monitor_propane_level.html">Monitoring Propane Level</a></li>
              <li><a href="adding_van_tilt_sensor.html">Adding a Van Tilt Sensor</a></li>
              <li><a href="autolocking_drawers.html">Auto-Locking Drawers</a></li>
            </ul>
          </li>
          <li><a class="nav-link scrollto" href="future_projects.html">Future Projects</a></li>
         <!-- <li><a class="nav-link scrollto" href="#contact">Contact</a></li> -->
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->

    </div>
  </header><!-- End Header -->

  <main id="main">

    <!-- ======= Breadcrumbs Section ======= -->
    <section class="breadcrumbs">
      <div class="container">

        <div class="d-flex justify-content-between align-items-center">
          <h2>Monitoring Solar Power</h2>
          <ol>
            <li><a href="index.html">Home</a></li>
            <li>Monitoring Solar Power</li>
          </ol>
        </div>

      </div>
    </section><!-- End Breadcrumbs Section -->

    <section class="tutorial_imgs">
        <div class="row">
          <div class="portfolio-details-slider swiper">
            <div class="swiper-wrapper align-items-center">
  
              <div class="swiper-slide">
                <img src="assets/img/solar/solar4.jpg" class="tut_swiper_img" alt="">
              </div>

              <div class="swiper-slide">
                <img src="assets/img/solar/solar1.jpeg" class="tut_swiper_img" alt="">
              </div>
  
              <div class="swiper-slide">
                <img src="assets/img/solar/solar2.jpeg" class="tut_swiper_img" alt="">
              </div>

              <div class="swiper-slide">
                <img src="assets/img/solar/solar5.jpg" class="tut_swiper_img" alt="">
              </div>
  
              <div class="swiper-slide">
                <img src="assets/img/solar/solar3.png" class="tut_swiper_img" alt="">
              </div>
  
            </div>
            <div class="swiper-pagination"></div>
          </div>
        </div>
      </section>

    <section class="inner-page">
      <div class="container">
        <div>&nbsp;With the lights set up and working, next I wanted to add some monitoring of different systems in the  van. The first one I thought I'd tackle was monitoring the solar power by interfacing with my charge controller. </div>
        <div><br /></div>
        <div>Items needed to set this up:</div>
        <div class="amazon">
          <ul>
            <li><b><a href="https://www.amazon.com/gp/product/B07DNVW37B" target="_blank">
              Renogy Rover Charge Controller</a>:</b>
              &nbsp;I have the 30Aversion shown here, but this setup should work with any of charge controllers in this series</li>
            <li><b><a href="https://www.amazon.com/gp/product/B00IDSM6BW" target="_blank">
              USB Serial Dongle</a>:</b>&nbsp;For serial communication from the Raspberry Pi to the Charge Controller</li>
            <li><b><a href="https://www.amazon.com/gp/product/B0054RRCHI" target="_blank">
              DB9 to RJ12 adapter</a>:</b>&nbsp;The charge controller uses a non-standard serial pinout, so this adapter is needed to connect to it</li>
            <li><b><a href="https://www.amazon.com/gp/product/B08BHVF6XS" target="_blank">
              RJ12 Cable</a>:</b>&nbsp;To connect from the adapter to the Charge Controller</li>
          </ul>
        </div>
        <div>&nbsp;In order for the Raspberry Pi to communicate with the Renogy charge controller, we need a USB to RJ12
        serial cable. Renogy used to include this cable with their charge controllers, but since introducing their bluetooth
        module, they stopped making it. So instead we'll have to make our own!</div>
        <div><br /></div>
        <div>&nbsp;The three components of the cable are the USB serial dongle which allows the raspberry pi to
          communicate in the correct protocol for the charge controller, then the DB9 to RJ12 adapter and the RJ12 cable
          which allows you to connect to the Renogy charge controller with the correct pin mapping.</div>
        <div><br /></div>
        <div>&nbsp;The Renogy Charge Controller uses a non-standard pinout which is why we will be using the modular adapter kit. 
          This kit allows you to use any pin mapping you'd like when going from RJ12 to DB9, but requires a bit of work to get set up correctly.
        </div>
        <div><br /></div>
        <div>&nbsp;The pin mapping of the RJ12 connector for the Renogy charge controller is: TX/RX/GND/GND/+12V/+12V. On
          the USB serial dongle, pin 2 is RXD, pin 3 is TXD, and pin 5 is GND. We need to connect the RJ12 TX to the serial dongle RXD and the RJ12 RX to the serial dongle TXD. We then need to also connect GND. This is done using the DB9 to RJ12 adapter as shown below.</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/solar/solar1.jpeg">
        </div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/solar/solar2.jpeg">
        </div>
        <div><br /></div>
        <div>&nbsp;Once the cable is made, I recommend connecting it to the Renogy charge controller, then using a multimeter to test the pin voltages before connecting it to the serial dongle. TX to GND and TX to RX should both be about 5V. Make sure you didn't accidentally connect the 12V pins or you could fry the serial dongle and possibly even the raspberry pi.</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/solar/solar5.jpg">
        </div>
        <div><br /></div>
        <div>&nbsp;With the cable now connected between the raspberry pi and the charge controller, we now need some
          software to read registers from the charge controller. First find the name of the USB serial dongle on your
          raspberry pi with:</div>
        <div class="terminal">
            pi@raspberrypi:~ $ ls /dev/*USB*<br>
            /dev/ttyUSB0
        </div>
        <div>&nbsp;Now we can start writing a python program. Luckily, someone has already written a library called
          Solarshed that handles reading data from the charge controller. More info on this library here:
        </div>
        <div class="tut_link"><a
            href="https://github.com/corbinbs/solarshed" target="_blank">https://github.com/corbinbs/solarshed</a>
        </div>
        <div><br /></div>
        <div>&nbsp;You can install Solarshed with:</div>
        <div class="terminal">
            pip install solarshed
        </div>
        <div>&nbsp; I have a basic program posted here that reads the current solar power from the charge controller every
            second using Solarshed and publishes the data to the MQTT server running on the Raspberry Pi:
        </div>
        <div class="tut_link">
          <a href="https://github.com/CF209/vanomation/blob/main/python/solar/solar_mqtt.py" target="_blank">solar_mqtt.py</a>
        </div>
        <div><br /></div>
        <div>&nbsp;If your serial dongle is at a different address, you can change it on this line:</div>
        <div class="terminal">
          controller = RenogyRover(<b>'/dev/ttyUSB0'</b>, 1)
        </div>
        <div>&nbsp;You can also edit the script to add monitoring of more than just power or other features.</div>
        <div><br /></div>
        <div>&nbsp;In order to have this script always running, we will turn it into a systemd service. Create a new file
          with:</div>
        <div class="terminal">
          sudo nano /lib/systemd/system/solar_mqqt.service
        </div>
        <div>And add the following to the file changing the ExecStart path to the path of your python script:</div>
        <div class="terminal">
            [Unit]<br>
            Description=Solar MQTT<br>
            After=multi-user.target<br>
            <br>
            [Service]<br>
            Type=idle<br>
            ExecStart=/usr/bin/python3 <b>/home/pi/python/solar/solar_mqtt.py</b><br>
            WorkingDirectory=/home/pi<br>
            User=pi<br>
            Restart=on-failure<br>
            RestartSec=5s<br>
            <br>
            [Install]<br>
            WantedBy=multi-user.target
        </div>
        <div>&nbsp;Save the file, then you can enable the service with:</div>
        <div class="terminal">
            sudo systemctl daemon-reload<br>
            sudo systemctl enable solar_mqqt.service
        </div>
        <div>To check that the service is running:</div>
        <div class="terminal">
            sudo systemctl status solar_mqtt.service
        </div>
        <div>&nbsp;The final step is to add this new sensor to Home Assistant. In Home Assistant, go to Configuration -&gt; Integrations and add the MQTT integration if you don't have it already. Now go to your configuration.yaml file in your homeassistant directory and add the following sensor:</div>
        <div class="terminal">
            sensor:<br>
            &emsp; - platform: mqtt<br>
            &emsp;&emsp;&emsp; state_topic: "van/solar/power"<br>
            &emsp;&emsp;&emsp; name: 'Solar Power'<br>
            &emsp;&emsp;&emsp; unit_of_measurement: 'W'<br>
            &emsp;&emsp;&emsp; value_template: '{{ value_json.power }}'
        </div>
        <div>&nbsp;Restart Home Assistant and you should now be able to add the sensor to your dashboard!</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/solar/solar3.png">
        </div>
        <div><br /></div>
        <div class="next_link">
          <a href="monitor_water_level.html">Next: Monitoring Water Level</a>
        </div>
        <div><br /></div>
      </div>
    </section>

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">
    <div class="footer-top">
      <div class="container">
        <div class="row">
          <p style="text-align: center">
            See more at <a href="https://github.com/CF209">https://github.com/CF209</a>
          </p>

        </div>
      </div>
    </div>

    <div class="container">
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/ -->
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/purecounter/purecounter.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>