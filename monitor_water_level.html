<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>Monitoring Water Level</title>
  <meta content="" name="description">
  <meta content="" name="keywords">

  <!-- Favicons -->
  <link href="assets/img/favicon.png" rel="icon">
  <link href="assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Raleway:300,300i,400,400i,500,500i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="assets/vendor/aos/aos.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
  <link href="assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="assets/css/style.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: Squadfree - v4.6.0
  * Template URL: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="fixed-top ">
    <div class="container d-flex align-items-center justify-content-between">

      <div class="logo">
        <h1 class="text-light"><a href="index.html"><span>Vanomation</span></a></h1>
        <!-- Uncomment below if you prefer to use an image logo -->
        <!-- <a href="index.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
      </div>

      <nav id="navbar" class="navbar">
        <ul>
          <li><a class="nav-link scrollto active" href="index.html#hero">Home</a></li>
          <li><a class="nav-link scrollto" href="index.html#about">About</a></li>
          <li><a class="nav-link scrollto" href="index.html#pictures">Pictures</a></li>
          <li class="dropdown"><a href="#"><span>Tutorials</span> <i class="bi bi-chevron-down"></i></a>
            <ul>
              <li><a href="setting_up_raspberry_pi.html">Setting up the Raspberry Pi</a></li>
              <li><a href="installing_home_assistant.html">Installing Home Assistant</a></li>
              <li><a href="control_the_lights.html">Controlling the Lights</a></li>
              <li><a href="add_wireless_switches.html">Adding Wireless Switches</a></li>
              <li><a href="monitor_solar_power.html">Monitoring Solar Power</a></li>
              <li><a href="monitor_water_level.html">Monitoring Water Level</a></li>
              <li><a href="monitor_propane_level.html">Monitoring Propane Level</a></li>
              <li><a href="adding_van_tilt_sensor.html">Adding a Van Tilt Sensor</a></li>
              <li><a href="autolocking_drawers.html">Auto-Locking Drawers</a></li>
            </ul>
          </li>
          <li><a class="nav-link scrollto" href="future_projects.html">Future Projects</a></li>
         <!-- <li><a class="nav-link scrollto" href="#contact">Contact</a></li> -->
        </ul>
        <i class="bi bi-list mobile-nav-toggle"></i>
      </nav><!-- .navbar -->

    </div>
  </header><!-- End Header -->

  <main id="main">

    <!-- ======= Breadcrumbs Section ======= -->
    <section class="breadcrumbs">
      <div class="container">

        <div class="d-flex justify-content-between align-items-center">
          <h2>Monitoring Water Level</h2>
          <ol>
            <li><a href="index.html">Home</a></li>
            <li>Monitoring Water Level</li>
          </ol>
        </div>

      </div>
    </section><!-- End Breadcrumbs Section -->

    <section class="tutorial_imgs">
        <div class="row">
          <div class="portfolio-details-slider swiper">
            <div class="swiper-wrapper align-items-center">
  
              <div class="swiper-slide">
                <img src="assets/img/water/water1.png" class="tut_swiper_img" alt="">
              </div>

              <div class="swiper-slide">
                  <img src="assets/img/water/water2.png" class="tut_swiper_img" alt="">
                </div>
  
            </div>
            <div class="swiper-pagination"></div>
          </div>
        </div>
      </section>
  

    <section class="inner-page">
      <div class="container">
        <div>&nbsp; The next thing in my van that I wanted to monitor was the amount of water in my freshwater tank.
          Previously I would have to peek through a little door on the side of my cabinet and make a rough estimate, so
          being able to quickly pull out my phone and check was a huge improvement.</div>
        <div>Items needed to set this up:</div>
        <div class="amazon">
          <ul>
            <li><b><a href="https://www.amazon.com/ICON-12460-Filler-WT2460-20-Gallon/dp/B01MR55AEA" target="_blank">
              Water Tank</a>:</b>&nbsp;I have this 20 gallon tank in my
                van. Any water tank with a flat top should work, but tanks that are too short could have less accurate
                results</li>
            <li><b><a href="https://www.amazon.com/gp/product/B00Y831XA6" target="_blank">
              KUS Water Level Sensor</a>:</b>&nbsp;I used this 15" sensor
                for this project. For plastic tanks they recommend using a sensor 1" shorter than the height of your
                tank</li>
            <li><b><a href="https://kus-usa.com/product/fls-u/" target="_blank">
              Water Sensor Flange</a>:</b>&nbsp;This is needed to mount the water sensor to the tank</li>
            <li><b><a href="https://www.amazon.com/gp/product/B07R5S27GC" target="_blank">
              40mm Hole Saw</a>:</b>&nbsp;To cut a hole in the top of the water tank</li>
            <li><b>ADC Electronics: </b>I designed a custom PCB
                  using an ESP8266, but other options can be used. See below for details</li>
          </ul>
        </div>
        <div>&nbsp;For this project we will be cutting a hole in the top of the water tank, so be very careful or you could
        ruin your tank.</div>
        <div><br /></div>
        <div>&nbsp;Start by draining the water tank. Drilling the holes in the tank tends to leave plastic residue inside,
          so it'll be easier to clean up if the tank is empty.</div>
        <div><br /></div>
        <div>&nbsp;Choose the location on the water tank where you will drill your hole in the top of the tank. The closer
          to the center of the tank, the less your readings will be affected by parking on a hill.</div>
        <div><br /></div>
        <div>&nbsp;Start by drilling the 40mm hole in the tank. Once this hole is complete, we then need to drill the 5
          screw holes around it. You can use the flange or the sensor as a template to mark the location of the holes. Make
          sure it is completely centered. Drill out these 5 holes just big enough for the screws to fit through (I forget
          the exact drill size I used here, but I started small and gradually increased the size until the screws fit). Take
          note of the orientation you use here since the drill pattern is not symmetrical. With the holes drilled, you'll
          now want to vacuum out any of the plastic debris from inside the tank.</div>
        <div><br /></div>
        <div>&nbsp;Next we will install the sensor using the flange. The flange goes inside the tank and the gasket and
          sensor go on top with the screws clamping it together. The flange is c-shaped which allows it to fit through the
          40mm hole. Be very careful not to drop it inside the tank. I bought longer 3" screws with the same thread as the
          flange to make this process easier. By threading these longer screws, I could hold the flange in place while
          lining up the sensor and starting some of the shorter screws. Once two screws are in place, it should stay lined
          up and the remaining 3 should be easier. Tighten everything down to create a good seal with the gasket and
          you're good to go!</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/water/water1.png">
        </div>
        <div><br /></div>
        <div>&nbsp;Next we need to connect this sensor into Home Assistant. This water level sensor essentially acts as a
          variable resistor that varies from 33Ω at full and 240Ω at empty. In order to read this resistance we will use a
          voltage divider to convert the resistance to a voltage which can be read by an ADC (analog to digital
          converter). Here is the circuit I used:</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/water/water2.png">
        </div>
        <div><br /></div>
        <div>&nbsp;Connector J4 connects to the water level sensor, and the water voltage signal goes to the ADC. The
          water level sensor should be able to be connected in either direction since it's just a resistor, but one of the
          wires was black so I connected that one to GND. The capacitor was added to help reduce any noise. The ADC I'm
          using has a max voltage of 1V. By choosing a resistor value of 1k, this should in theory create a voltage range
          from 0.105V to 0.639V.</div>
        <div><br /></div>
        <div>&nbsp;Unfortunately the Raspberry Pi doesn't have an ADC built in, so an external one is required. I
          originally used an ADS1115 which connected to the Raspberry Pi with i2c, but because my water tank was so far
          away from the Raspberry Pi, I was having a lot of issues with noise. I instead decided to use an ESP8266 which
          has an ADC built in and can communicate with the Raspberry Pi over Wifi.&nbsp;</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/water/water3.png">
        </div>
        <div><br /></div>
        <div>&nbsp;For the ESP8266 I designed
          a custom PCB. This PCB runs on the 12V which I already have wired all over my van, uses a 3.3V step down
          buck converter to power the ESP8266, and has a connector for the water level sensor wires and the voltage
          divider circuit described above. The board also has a few other features that I plan to use for future
          projects, but can be ignored for now. All chosen components are also easily hand-solderable. The KICAD files
          can be found here:</div>
        <div class="tut_link">
          <a href="https://github.com/CF209/kicad/tree/main/ESP8266_Water_Sensor" target="_blank">Water Sensor KICAD files</a>
        </div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/water/water4.png">
        </div>
        <div><br /></div>
        <div>&nbsp;The easiest way to configure an ESP8266 or ESP32 device to work with Home Assistant is by using
          ESPHome. ESPHome allows you to quickly and easily configure an ESP8266 or ESP32 for different functions and
          allows you to apply future updates wirelessly. You can install ESPHome in docker using:&nbsp;</div>
        <div class="terminal">
          sudo docker pull esphome/esphome<br>
          sudo docker run -d --name="esphome " --net=host -p 6052:6052 -p 6123:6123 --privileged --restart always -v /home/pi/esphome:/config esphomt/esphome
        </div>
        <div>&nbsp;I ran it in privileged mode so ESPHome would have access to the USB ports for initially programming
          any ESP32 or ESP8266 devices. After it's running, you should be able to access it by going to&nbsp;<a
            href="http://192.168.0.101:6052/" target="_blank">http://192.168.0.101:6052/</a>&nbsp;in your web browser.
        </div>
        <div><br /></div>
        <div>&nbsp;To create a new device, click the "plus" button in the bottom right corner. Enter a name, choose a
          device type (Generic ESP8266 for my custom board), and enter your wifi details. I then added the following
          code to the file:</div>
        <div class="terminal">
            sensor:<br>
            &emsp;- platform: adc<br>
            &emsp;&emsp;pin: A0<br>
            &emsp;&emsp;name: "Water Level Voltage"<br>
            &emsp;&emsp;id: water_voltage<br>
            &emsp;&emsp;update_interval: 1s<br>
            &emsp;&emsp;accuracy_decimals: 3
        </div>
        <div>&nbsp;This code tells the ESP8266 to read the voltage on the ADC pin every 1 second. To initially program
          the device, select the correct device in the upper right hand corner, then click "Upload". For my custom board
          I use this USB dongle to initially program it:</div>
        <div class="tut_link">
		      <a href="https://www.amazon.com/gp/product/B07BBPX8B8" target="_blank">FT232 USB to TTL Serial Adapter</a>
        </div>
        <div><br /></div>
        <div>&nbsp;With it programmed, I could now install it with the water sensor</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/water/water5.png">
        </div>
        <div><br /></div>
        <div>&nbsp;To connect it to Home Assistant, open the webpage and go to Configurations -&gt; Integrations and add
          the ESPHome integration. Once added, the ESPHome integration should automatically detect any ESPHome devices
          on your network. Add your water level sensor and you should now have access to the voltage readings.</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/water/water6.png">
        </div>
        <div><br /></div>
        <div>Because I wasn't sure what voltages I'd see at different water levels, I kept logs of the voltage as my
          water tank was emptied and then fully refilled. I then had a complete set of data and could assign percentage
          values to different voltages.</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/water/water7.png">
        </div>
        <div><br /></div>
        <div>&nbsp;I then added the following code to my ESPHome file and updated it to now send percent values in
          addition to voltages:</div>
        <div class="terminal">
          &emsp;- platform: template<br>
          &emsp;&emsp;name: "Water Level Percent"<br>
          &emsp;&emsp;unit_of_measurement: "%"<br>
          &emsp;&emsp;accuracy_decimals: 0<br>
          &emsp;&emsp;update_interval: 1s<br>
          &emsp;&emsp;lambda: |-<br>
          &emsp;&emsp;  if (id(water_voltage).state &lt; 0.162) {<br>
          &emsp;&emsp;    return 100;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.194) {<br>
          &emsp;&emsp;    return 93;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.2255) {<br>
          &emsp;&emsp;    return 87;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.2505) {<br>
          &emsp;&emsp;    return 80;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.2705) {<br>
          &emsp;&emsp;    return 73;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.29) {<br>
          &emsp;&emsp;    return 67;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.308) {<br>
          &emsp;&emsp;    return 60;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.326) {<br>
          &emsp;&emsp;    return 53;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.3445) {<br>
          &emsp;&emsp;    return 47;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.362) {<br>
          &emsp;&emsp;    return 40;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.398) {<br>
          &emsp;&emsp;    return 33;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.452) {<br>
          &emsp;&emsp;    return 27;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.5045) {<br>
          &emsp;&emsp;    return 20;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.562) {<br>
          &emsp;&emsp;    return 13;<br>
          &emsp;&emsp;  } else if (id(water_voltage).state &lt; 0.6215) {<br>
          &emsp;&emsp;    return 7;<br>
          &emsp;&emsp;  } else {<br>
          &emsp;&emsp;    return 0;<br>
          &emsp;&emsp;  }
        </div>
        <div>&nbsp;Success! I now have a fully functional water level sensor integrated with Home Assistant.</div>
        <div><br /></div>
        <div class="tut_img">
          <img src="assets/img/water/water8.png">
        </div>
        <div><br /></div>
        <div class="next_link">
          <a href="monitor_propane_level.html">Monitoring Propane Level</a>
        </div>
        <div><br /></div>
      </div>
    </section>

  </main><!-- End #main -->

  <!-- ======= Footer ======= -->
  <footer id="footer">
    <div class="footer-top">
      <div class="container">
        <div class="row">
          <p style="text-align: center">
            See more at <a href="https://github.com/CF209">https://github.com/CF209</a>
          </p>

        </div>
      </div>
    </div>

    <div class="container">
      <div class="credits">
        <!-- All the links in the footer should remain intact. -->
        <!-- You can delete the links only if you purchased the pro version. -->
        <!-- Licensing information: https://bootstrapmade.com/license/ -->
        <!-- Purchase the pro version with working PHP/AJAX contact form: https://bootstrapmade.com/squadfree-free-bootstrap-template-creative/ -->
        Designed by <a href="https://bootstrapmade.com/">BootstrapMade</a>
      </div>
    </div>
  </footer><!-- End Footer -->

  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="assets/vendor/aos/aos.js"></script>
  <script src="assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendor/glightbox/js/glightbox.min.js"></script>
  <script src="assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>
  <script src="assets/vendor/php-email-form/validate.js"></script>
  <script src="assets/vendor/purecounter/purecounter.js"></script>
  <script src="assets/vendor/swiper/swiper-bundle.min.js"></script>

  <!-- Template Main JS File -->
  <script src="assets/js/main.js"></script>

</body>

</html>